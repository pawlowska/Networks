---
title: "Network analysis of alcohol data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('~/GitHub/Networks/Network_Analysis_Tools.R')
library(data.table)

```


```{r read data and add graph info}
dane<-fread("C:/Users/Monik/Documents/GitHub/sredni_sygnal_mozgu/pliki/summarized_unweighted_alcohol.csv")

dane[,idx:=NULL]
dane[,group_id:=NULL]
dane[,name:=NULL]

parents<-fread("C:/Users/Monik/Documents/GitHub/sredni_sygnal_mozgu/pliki/parents.txt", header = FALSE)
setnames(parents, c("V1", "V2"), c("abbrev", "parent"))
dane<-merge(dane, parents, by = "abbrev")
dane[,is_parent:=FALSE][unique(dane$parent), is_parent:=TRUE]

```

```{r make list}
dane_wybrane<-dane[depth==4]
lista.danych<-split(dane_wybrane, by="group_label", keep.by=FALSE)
lista.danych<-lapply(lista.danych, 
                     function(x) {
                       transpose(dcast(x, abbrev ~ case_id, value.var = "cell_count"), make.names = "abbrev")})
lista.danych<-lapply(lista.danych, function(x) setDF(x))
lista.danych <- lapply(lista.danych, clean_data, missing_thresh=3, fill_missing=FALSE, real_zeros=FALSE)

rm(dane)
rm(dane_wybrane)
```



```{r correlation matrices}
lista.corr <- lapply(lista.danych, function(x) rcorr(as.matrix(x))$r)
lista.corr <- lapply(lista.corr, function(x) {diag(x) <- 0; x})

```
## Including Plots


```{r pressure, echo=FALSE}
col<- colorRampPalette(c("blue", "white", "red"))(20)
heatmap(x = lista.corr[['relapse']], col = col, symm = TRUE)
```
```{r}
heatmap(x = lista.corr[['alcohol']], col = col, symm = TRUE)

```
```{r}
#Get threshold to make networks the same density
cost = 0.8
l.threshold <- lapply(lista.corr, function(x) quantile(abs(x), probs=cost, na.rm=TRUE))
l.G <- mapply(df_to_igraph, lista.danych, l.threshold, negs=TRUE, thresh.param='r', SIMPLIFY=FALSE)


#Get some centrality measures for each graph
l.df.centrality <- lapply(l.G, get_centrality_measures)
l.df.centrality <- lapply(l.df.centrality, function(x) {x$region <- rownames(x) ; x})


#Make a couple of figures; let's sort by degree first
l.df.centrality <- lapply(l.df.centrality, function(x) {out <- x[order(x$degree, decreasing=TRUE),] ; out})
#need to reorder the factors
l.df.centrality <- lapply(l.df.centrality, function(x) {x$region <- factor(x$region, levels=x$region) ; x})

#now let's plot
lapply(seq_along(l.df.centrality), function(d,y,i) {ggplot(d[[i]], aes(x=region, y=degree)) + 
                                                      geom_bar(stat='identity') + 
                                                      ggtitle(y[[i]])}, d = l.df.centrality, y=names(l.df.centrality))
```

```{r}

#Now for betweenness
l.df.centrality <- lapply(l.df.centrality, function(x) {out <- x[order(x$betweenness, decreasing=TRUE),] ; out})
#need to reorder the factors
l.df.centrality <- lapply(l.df.centrality, function(x) {x$region <- factor(x$region, levels=x$region) ; x})

#now let's plot
lapply(seq_along(l.df.centrality), function(d,y,i) {ggplot(d[[i]], aes(x=region, y=betweenness)) + 
                                                      geom_bar(stat='identity') + 
                                                      ggtitle(y[[i]])}, d = l.df.centrality, y=names(l.df.centrality))
```